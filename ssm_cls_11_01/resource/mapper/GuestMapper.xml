<?xml version="1.0" encoding="UTF-8" ?>
 <!DOCTYPE mapper
   PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
     "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.bawei.dao.GuestDao">
	<resultMap type="Guest" id="guestMap">
		<id column="id" property="id"/>
		<result column="guestName" property="guestName"/>
		<result column="telephone" property="telephone"/>
		<result column="isHidden" property="isHidden"/>
		<result column="sex" property="sex"/>
		<result column="email" property="email"/>
		<result column="company" property="company"/>
		<result column="dept" property="dept"/>
		<result column="duty" property="duty"/>
		<result column="isShow" property="isShow"/>
		<collection property="meetings" 
			select="com.bawei.dao.MeetingDao.findMeetingByGuestId"
			ofType="Meeting" column="{gid=id,meetingName=meetingName}"></collection>
	</resultMap>
	
	<!-- 查找嘉宾信息 -->
	<select id="findGuest" resultMap="guestMap">
		select g.*,#{meetingName} meetingName from guest g
		<where>
			<if test="guestName!=null and guestName!=''">
				and guestName like concat('%',#{guestName},'%')
			</if>
			<if test="telephone!=null and telephone!=''">
				and telephone like concat('%',#{telephone},'%')
			</if>
			<if test="company!=null and company!=''">
				and company like concat('%',#{company},'%')
			</if>
			<if test="meetingName!=null">
				and id in(
					select gm.gid from guest_meeting gm 
					join meeting m  on gm.mid=m.id
					where gm.gid=g.id
					<if test="meetingName!=null and meetingName!=''">
						and meetingName like concat('%',#{meetingName},'%')
					</if>
				)		
			</if>
		</where>
	</select>


	<resultMap type="Guest" id="guestJoinMap">
		<id column="gid" property="id"/>
		<result column="guestName" property="guestName"/>
		<result column="gtel" property="telephone"/>
		<result column="isHidden" property="isHidden"/>
		<result column="sex" property="sex"/>
		<result column="email" property="email"/>
		<result column="company" property="company"/>
		<result column="dept" property="dept"/>
		<result column="duty" property="duty"/>
		<result column="isShow" property="isShow"/>
		<collection property="meetings" ofType="Meeting" 
		resultMap="com.bawei.dao.MeetingDao.meetingMap">
			
		</collection>
	
	</resultMap>
	
	<!-- 使用join语句查询 -->
	<select id="findGuestJoin" resultType="HashMap">
		select 
			g.id gid,guestName,g.telephone gtel,g.isHidden,
			g.sex,g.email,g.company,g.dept,g.duty,g.isShow,
			group_concat(m.id) mid,group_concat(m.meetingName) meetingName,
			group_concat(m.startTime) startTime,group_concat(m.endTime) endTime
		from guest g
		join guest_meeting gm on g.id=gm.gid
		join meeting m on m.id=gm.mid
	<where>
			<if test="guestName!=null and guestName!=''">
				and g.guestName like concat('%',#{guestName},'%')
			</if>
			<if test="telephone!=null and telephone!=''">
				and g.telephone like concat('%',#{telephone},'%')
			</if>
			<if test="company!=null and company!=''">
				and g.company like concat('%',#{company},'%')
			</if>
			<if test="meetingName!=null and meetingName!=''">
				and m.meetingName like concat('%',#{meetingName},'%')
			</if>
		</where>
		group by g.id
	</select>
</mapper>









